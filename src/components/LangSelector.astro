---
import World from '../assets/icons/world.svg';
import {LANGUAGES,LANGUAGES_KEYS,DEFAULT_LANG} from "../i18n/utils";
import type {UiType} from "../i18n/utils";
---

<div id="lang-selector" class="dropdown" data-languages={JSON.stringify(LANGUAGES_KEYS)} data-default-lang={DEFAULT_LANG}>
  <div tabindex="0" role="button" class="btn m-1">
    <World width="24" height="24" />
  </div>
  <ul
    tabindex="0"
    class="dropdown-content menu bg-base-100 rounded-box z-1 w-52 p-2 shadow-sm"
    id="lang-options"
  >
    {
      LANGUAGES_KEYS.map((key: UiType) => (
        <li>
          <a href="#" data-lang={key} class="lang-option">{LANGUAGES[key]}</a>
        </li>
      ))
    }
  </ul>
</div>

<!-- ðŸ”½ Dil seÃ§imi iÃ§in client-side script -->
<script is:inline>
  document.addEventListener("DOMContentLoaded", () => {
    const container = document.getElementById("lang-selector");
    if (!container) return;
    const langButtons = container.querySelectorAll(".lang-option");
    const languages = JSON.parse(container.getAttribute("data-languages"));
    const defaultLang = container.getAttribute("data-default-lang");
    const savedLang = localStorage.getItem("preferredLanguage") ?? defaultLang;

    // Sayfa yÃ¼klenirken kaydedilen dile yÃ¶nlendir
    const currentPath = window.location.pathname;
    const pathParts = currentPath.split('/').filter(part => part !== '');
    const currentLang = pathParts.length > 0 && languages.includes(pathParts[0]) ? pathParts[0] : defaultLang;
    const hasLangInPath = pathParts.length > 0 && languages.includes(pathParts[0]);

    // YalnÄ±zca URL dil iÃ§ermiyorsa otomatik yÃ¶nlendir ve her zaman dil prefiksi ekle
    if (!hasLangInPath && savedLang !== currentLang) {
      const restParts = hasLangInPath ? pathParts.slice(1) : pathParts;
      const restPath = restParts.join('/');
      let newPath = `/${savedLang}`;
      if (restPath) newPath += `/${restPath}`;
      window.location.href = newPath;
      return;
    }

    langButtons.forEach((btn) => {
      btn.addEventListener("click", (e) => {
        e.preventDefault();
        const selectedLang = btn.getAttribute("data-lang") ?? defaultLang;
        localStorage.setItem("preferredLanguage", selectedLang);
        const currentPath = window.location.pathname;
        const parts = currentPath.split('/').filter(p => p !== '');
        const restParts = parts.length > 0 && languages.includes(parts[0]) ? parts.slice(1) : parts;
        const restPath = restParts.join('/');
        let newPath = `/${selectedLang}`;
        if (restPath) newPath += `/${restPath}`;
        window.location.href = newPath;
      });
    });
  });
</script>

