---
import { getBlogPosts } from "../../../content/config";
import { LANGUAGES, getTagsByLanguage } from "../../../i18n/utils";
import type { UiType } from "../../../i18n/utils";
import Layout from "../../../layouts/Layout.astro";
import PostCard from "../../../components/PostCard.astro";

export async function getStaticPaths() {
  const posts = await getBlogPosts();
  return Object.keys(LANGUAGES).flatMap((lang) => {
    const postsForLang = posts.filter((post) => post?.data?.lang === lang);
    const tags = [...new Set(postsForLang.flatMap((post) => post?.data?.tags || []))];
    return tags.map((tag) => ({ params: { lang, tag: tag.toLocaleLowerCase(lang) } }));
  });
}

const { lang, tag } = Astro.params;
const posts = await getBlogPosts();
const tagsWithPosts = getTagsByLanguage(posts, lang as UiType);
const tagSlug = String(tag);
const tagData = tagsWithPosts.find(t => t.tag.toLocaleLowerCase(lang as UiType) === tagSlug);
---
<Layout title={`Tag: ${tagData?.tag ?? tag}`} description={`Tag: ${tagData?.tag ?? tag}`} lang={lang}>
  <h1 class="text-2xl font-bold mb-4">Tag: {tagData?.tag ?? tag}</h1>
  {tagData ? (
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      {tagData.posts.map(post => (
        <PostCard post={post} lang={lang} />
      ))}
    </div>
  ) : (
    <div class="alert alert-info">No posts found for this tag.</div>
  )}
</Layout>